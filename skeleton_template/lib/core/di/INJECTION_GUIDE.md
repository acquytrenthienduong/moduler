# üîß Injection.dart - Khi n√†o c·∫ßn can thi·ªáp?

## üìç File: `lib/core/di/injection.dart`

File n√†y qu·∫£n l√Ω **Dependency Injection** cho to√†n b·ªô app.

---

## ‚úÖ KHI N√ÄO C·∫¶N CAN THI·ªÜP

### 1. ‚ùå KH√îNG C·∫¶N (Auto-generated)

C√°c tr∆∞·ªùng h·ª£p sau **KH√îNG** c·∫ßn s·ª≠a `injection.dart`:

#### ‚úÖ T·∫°o Repository m·ªõi v·ªõi `@singleton`
```dart
// lib/features/order/data/repositories/order_repository.dart
@singleton
class OrderRepository {
  final ApiClient _client;
  OrderRepository(this._client);  // ‚úÖ Auto-inject
}
```
‚Üí **Injectable t·ª± ƒë·ªông register**, kh√¥ng c·∫ßn th√™m v√†o `injection.dart`

#### ‚úÖ T·∫°o Provider m·ªõi (Riverpod)
```dart
// lib/features/order/presentation/providers/order_provider.dart
@riverpod
OrderRepository orderRepository(Ref ref) {
  return GetIt.instance<OrderRepository>();  // ‚úÖ T·ª± l·∫•y t·ª´ GetIt
}
```
‚Üí **Riverpod t·ª± generate**, kh√¥ng c·∫ßn config

#### ‚úÖ T·∫°o Model m·ªõi (Freezed)
```dart
@freezed
abstract class Order with _$Order {...}
```
‚Üí **Freezed t·ª± generate**, kh√¥ng c·∫ßn DI

---

### 2. ‚úÖ C·∫¶N CAN THI·ªÜP

C√°c tr∆∞·ªùng h·ª£p sau **C·∫¶N** s·ª≠a `injection.dart`:

#### 1Ô∏è‚É£ Th√™m API Client m·ªõi (Multiple APIs)

**Khi n√†o**: App c·∫ßn call nhi·ªÅu API kh√°c nhau (analytics, payment, etc)

**V√≠ d·ª•**:
```dart
@module
abstract class RegisterModule {
  @preResolve
  @singleton
  Future<SharedPreferences> get prefs => SharedPreferences.getInstance();

  /// Main API Client
  @singleton
  ApiClient apiClient(SharedPreferences prefs) {
    final client = ApiClient.withoutInterceptors();
    client.dio.interceptors.addAll([...]);
    return client;
  }

  /// ‚≠ê TH√äM: Analytics API Client
  @singleton
  AnalyticsApiClient analyticsClient() {
    return AnalyticsApiClient();
  }

  /// ‚≠ê TH√äM: Payment API Client
  @singleton
  PaymentApiClient paymentClient() {
    return PaymentApiClient();
  }
}
```

**Sau ƒë√≥ run**:
```bash
fvm flutter pub run build_runner build --delete-conflicting-outputs
```

---

#### 2Ô∏è‚É£ Customize Interceptors

**Khi n√†o**: C·∫ßn thay ƒë·ªïi interceptors (th√™m/x√≥a/s·ª≠a)

**V√≠ d·ª• 1: Disable logging trong production**
```dart
@singleton
ApiClient apiClient(SharedPreferences prefs) {
  final client = ApiClient.withoutInterceptors();
  
  client.dio.interceptors.addAll([
    // ‚≠ê CH·ªà log trong debug mode
    if (kDebugMode)
      CustomLoggingInterceptor(
        logRequest: true,
        logResponse: true,
        logError: true,
      ),
    
    AuthInterceptor(prefs),
    RefreshTokenInterceptor(client.dio, prefs),
    RetryInterceptor(maxRetries: 3),
  ]);
  
  return client;
}
```

**V√≠ d·ª• 2: Th√™m custom interceptor**
```dart
@singleton
ApiClient apiClient(SharedPreferences prefs) {
  final client = ApiClient.withoutInterceptors();
  
  client.dio.interceptors.addAll([
    CustomLoggingInterceptor(...),
    AuthInterceptor(prefs),
    RefreshTokenInterceptor(client.dio, prefs),
    RetryInterceptor(...),
    
    // ‚≠ê TH√äM: Analytics interceptor
    AnalyticsInterceptor(),
    
    // ‚≠ê TH√äM: Sentry interceptor
    SentryInterceptor(),
  ]);
  
  return client;
}
```

**V√≠ d·ª• 3: Thay ƒë·ªïi retry config**
```dart
RetryInterceptor(
  maxRetries: 5,              // ‚≠ê TƒÉng t·ª´ 3 l√™n 5
  initialDelay: Duration(seconds: 2),  // ‚≠ê TƒÉng delay
),
```

---

#### 3Ô∏è‚É£ Register Service/Utility m·ªõi (Kh√¥ng ph·∫£i Repository)

**Khi n√†o**: C·∫ßn register service kh√¥ng ph·∫£i repository

**V√≠ d·ª• 1: Local Storage Service**
```dart
@module
abstract class RegisterModule {
  @preResolve
  @singleton
  Future<SharedPreferences> get prefs => SharedPreferences.getInstance();

  /// ‚≠ê TH√äM: Hive Database
  @preResolve
  @singleton
  Future<Box> get hiveBox async {
    await Hive.initFlutter();
    return await Hive.openBox('app_box');
  }
}
```

**V√≠ d·ª• 2: Firebase Service**
```dart
@module
abstract class RegisterModule {
  /// ‚≠ê TH√äM: Firebase Analytics
  @singleton
  FirebaseAnalytics get analytics => FirebaseAnalytics.instance;

  /// ‚≠ê TH√äM: Firebase Crashlytics
  @singleton
  FirebaseCrashlytics get crashlytics => FirebaseCrashlytics.instance;
}
```

**V√≠ d·ª• 3: Custom Service**
```dart
@module
abstract class RegisterModule {
  /// ‚≠ê TH√äM: Location Service
  @singleton
  LocationService locationService() {
    return LocationService();
  }

  /// ‚≠ê TH√äM: Notification Service
  @singleton
  NotificationService notificationService() {
    return NotificationService();
  }
}
```

---

#### 4Ô∏è‚É£ Environment-specific Configuration

**Khi n√†o**: C·∫ßn config kh√°c nhau cho dev/staging/prod

**V√≠ d·ª•**:
```dart
@module
abstract class RegisterModule {
  @singleton
  ApiClient apiClient(SharedPreferences prefs) {
    final client = ApiClient.withoutInterceptors();
    
    client.dio.interceptors.addAll([
      // ‚≠ê Dev: Full logging
      if (kDebugMode)
        CustomLoggingInterceptor(
          logRequest: true,
          logResponse: true,
          logError: true,
        ),
      
      // ‚≠ê Production: Only errors
      if (kReleaseMode)
        CustomLoggingInterceptor(
          logRequest: false,
          logResponse: false,
          logError: true,
        ),
      
      AuthInterceptor(prefs),
      
      // ‚≠ê Dev: No retry (faster debugging)
      if (kDebugMode)
        RetryInterceptor(maxRetries: 1),
      
      // ‚≠ê Production: More retries
      if (kReleaseMode)
        RetryInterceptor(maxRetries: 5),
    ]);
    
    return client;
  }
}
```

---

#### 5Ô∏è‚É£ Thay ƒë·ªïi Singleton Scope

**Khi n√†o**: C·∫ßn thay ƒë·ªïi lifecycle c·ªßa dependency

**V√≠ d·ª•**:
```dart
@module
abstract class RegisterModule {
  /// ‚≠ê Singleton - D√πng chung 1 instance
  @singleton
  ApiClient apiClient(SharedPreferences prefs) {...}

  /// ‚≠ê Factory - T·∫°o m·ªõi m·ªói l·∫ßn d√πng (HI·∫æM KHI D√ôNG)
  @factoryMethod
  TemporaryService tempService() {
    return TemporaryService();
  }

  /// ‚≠ê Lazy Singleton - Ch·ªâ t·∫°o khi c·∫ßn
  @lazySingleton
  HeavyService heavyService() {
    return HeavyService();
  }
}
```

**‚ö†Ô∏è L∆∞u √Ω**: 
- `@factoryMethod` cho **functions/utilities**, KH√îNG d√πng cho Models
- Models (Freezed) t·ª± t·∫°o factory constructor, KH√îNG c·∫ßn register trong DI
- Repository lu√¥n d√πng `@singleton`

---

## ‚ùå KHI N√ÄO KH√îNG N√äN CAN THI·ªÜP

### 1. Th√™m Repository th√¥ng th∆∞·ªùng
```dart
// ‚ùå KH√îNG C·∫¶N th√™m v√†o injection.dart
@singleton
class ProductRepository {
  final ApiClient _client;
  ProductRepository(this._client);
}
```
‚Üí Injectable t·ª± ƒë·ªông register

### 2. Th√™m Provider m·ªõi
```dart
// ‚ùå KH√îNG C·∫¶N th√™m v√†o injection.dart
@riverpod
ProductRepository productRepository(Ref ref) {
  return GetIt.instance<ProductRepository>();
}
```
‚Üí Riverpod t·ª± generate

### 3. Th√™m Model m·ªõi
```dart
// ‚ùå KH√îNG C·∫¶N th√™m v√†o injection.dart
@freezed
abstract class Product with _$Product {...}
```
‚Üí Freezed t·ª± generate

---

## üìã Checklist: C·∫ßn can thi·ªáp?

| Tr∆∞·ªùng h·ª£p | C·∫ßn s·ª≠a injection.dart? | L√Ω do |
|-----------|------------------------|-------|
| T·∫°o Repository m·ªõi v·ªõi `@singleton` | ‚ùå KH√îNG | Injectable auto-register |
| T·∫°o Provider m·ªõi (Riverpod) | ‚ùå KH√îNG | Riverpod auto-generate |
| T·∫°o Model m·ªõi (Freezed) | ‚ùå KH√îNG | Freezed auto-generate |
| Th√™m API Client m·ªõi | ‚úÖ C·∫¶N | Multiple APIs |
| Thay ƒë·ªïi Interceptors | ‚úÖ C·∫¶N | Custom config |
| Register Service m·ªõi | ‚úÖ C·∫¶N | Non-repository service |
| Environment config | ‚úÖ C·∫¶N | Dev/Prod differences |
| Thay ƒë·ªïi scope | ‚úÖ C·∫¶N | Lifecycle management |

---

## üîÑ Workflow

### Khi C·∫¶N can thi·ªáp:

```bash
# 1. S·ª≠a injection.dart
# Th√™m/s·ª≠a code trong RegisterModule

# 2. Generate code
fvm flutter pub run build_runner build --delete-conflicting-outputs

# 3. Verify
fvm flutter analyze

# 4. Test
fvm flutter run
```

### Khi KH√îNG C·∫¶N can thi·ªáp:

```bash
# 1. T·∫°o Repository/Model/Provider v·ªõi annotations
# @singleton, @freezed, @riverpod

# 2. Generate code
fvm flutter pub run build_runner build --delete-conflicting-outputs

# 3. Done! Injectable/Riverpod/Freezed t·ª± ƒë·ªông handle
```

---

## üí° Tips

### 1. Ki·ªÉm tra ƒë√£ register ch∆∞a
```dart
// Check trong code
if (GetIt.instance.isRegistered<MyService>()) {
  print('Already registered');
}
```

### 2. Debug DI issues
```bash
# Xem t·∫•t c·∫£ registered services
print(GetIt.instance.allReadySync());
```

### 3. Lazy loading
```dart
// Ch·ªâ load khi c·∫ßn
@lazySingleton
class HeavyService {...}
```

### 4. Testing
```dart
// Override trong tests
GetIt.instance.registerSingleton<ApiClient>(mockApiClient);
```

---

## üéØ Common Use Cases

### Use Case 1: App ƒë∆°n gi·∫£n (1 API)
```dart
@module
abstract class RegisterModule {
  @preResolve
  @singleton
  Future<SharedPreferences> get prefs => SharedPreferences.getInstance();

  @singleton
  ApiClient apiClient(SharedPreferences prefs) {...}
}
```
‚Üí **Kh√¥ng c·∫ßn th√™m g√¨**

### Use Case 2: App ph·ª©c t·∫°p (Multiple APIs)
```dart
@module
abstract class RegisterModule {
  @preResolve
  @singleton
  Future<SharedPreferences> get prefs => SharedPreferences.getInstance();

  @singleton
  ApiClient mainApi(SharedPreferences prefs) {...}

  @singleton
  AnalyticsApiClient analyticsApi() {...}  // ‚≠ê TH√äM

  @singleton
  PaymentApiClient paymentApi() {...}     // ‚≠ê TH√äM
}
```
‚Üí **C·∫ßn th√™m API clients**

### Use Case 3: Production app
```dart
@module
abstract class RegisterModule {
  @preResolve
  @singleton
  Future<SharedPreferences> get prefs => SharedPreferences.getInstance();

  @singleton
  ApiClient apiClient(SharedPreferences prefs) {
    // ‚≠ê Custom interceptors cho production
    final client = ApiClient.withoutInterceptors();
    client.dio.interceptors.addAll([
      if (kDebugMode) CustomLoggingInterceptor(...),
      AuthInterceptor(prefs),
      RefreshTokenInterceptor(client.dio, prefs),
      if (kReleaseMode) SentryInterceptor(),  // ‚≠ê TH√äM
      RetryInterceptor(...),
    ]);
    return client;
  }

  @singleton
  FirebaseAnalytics get analytics => FirebaseAnalytics.instance;  // ‚≠ê TH√äM
}
```
‚Üí **C·∫ßn th√™m services & custom interceptors**

---

## üìö Related Files

- `lib/core/di/injection.config.dart` - Generated (KH√îNG S·ª¨A)
- `lib/core/network/api_client.dart` - API client definitions
- `lib/core/network/interceptors/` - Interceptor implementations

---

## üéì Summary

**TL;DR:**

- ‚ùå **Repository m·ªõi**: KH√îNG c·∫ßn s·ª≠a (Injectable auto)
- ‚ùå **Provider m·ªõi**: KH√îNG c·∫ßn s·ª≠a (Riverpod auto)
- ‚ùå **Model m·ªõi**: KH√îNG c·∫ßn s·ª≠a (Freezed auto)
- ‚úÖ **API Client m·ªõi**: C·∫¶N s·ª≠a
- ‚úÖ **Custom Interceptors**: C·∫¶N s·ª≠a
- ‚úÖ **Service m·ªõi**: C·∫¶N s·ª≠a
- ‚úÖ **Environment config**: C·∫¶N s·ª≠a

**Quy t·∫Øc v√†ng**: N·∫øu c√≥ `@singleton` annotation trong Repository ‚Üí KH√îNG c·∫ßn s·ª≠a injection.dart

---

**Last updated**: October 2024

